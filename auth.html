<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Genie Auth</title>

    <!-- ✅ Supabase -->
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- ✅ Material Icons (for the chat icon button) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

    <style>
      :root {
        --primary-bg: #0a0b0f;
        --secondary-bg: #111219;
        --card-bg: rgba(17, 18, 25, 0.88);
        --accent-primary: #6366f1;
        --accent-secondary: #8b5cf6;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border: rgba(148, 163, 184, 0.2);
        --success-bg: rgba(16, 185, 129, 0.16);
        --success-text: #86efac;
        --error-bg: rgba(239, 68, 68, 0.16);
        --error-text: #fca5a5;
        --info-bg: rgba(59, 130, 246, 0.16);
        --info-text: #93c5fd;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      body {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 20px;
        background: radial-gradient(
            900px circle at 8% -10%,
            rgba(99, 102, 241, 0.28),
            transparent 55%
          ),
          radial-gradient(
            700px circle at 100% 0%,
            rgba(139, 92, 246, 0.22),
            transparent 50%
          ),
          var(--primary-bg);
      }

      .card {
        position: relative;
        width: 100%;
        max-width: 430px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        backdrop-filter: blur(12px);
        border-radius: 18px;
        padding: 28px 24px;
        box-shadow: 0 22px 60px rgba(0, 0, 0, 0.5);
        transition: opacity 220ms ease, transform 220ms ease;
      }

      /* ✅ page transition animation */
      .fade-out {
        opacity: 0;
        transform: translateY(10px);
      }
      .fade-in {
        opacity: 1;
        transform: translateY(0);
      }

      .close-auth {
        position: absolute;
        top: 12px;
        right: 12px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.7);
        color: var(--text-secondary);
        border-radius: 10px;
        width: 36px;
        height: 36px;
        font-size: 1.1rem;
        cursor: pointer;
      }

      .close-auth:hover {
        color: var(--text-primary);
        border-color: rgba(99, 102, 241, 0.6);
      }

      .title {
        text-align: center;
        font-size: 1.6rem;
        margin-bottom: 16px;
        color: var(--text-primary);
        font-weight: 700;
      }

      .tabs {
        display: flex;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.7);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 18px;
      }

      .tab {
        flex: 1;
        border: 0;
        padding: 11px 12px;
        cursor: pointer;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 600;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .tab.active {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        color: var(--text-primary);
      }

      .status {
        display: none;
        margin-bottom: 14px;
        padding: 10px;
        border-radius: 10px;
        font-size: 0.95rem;
        border: 1px solid transparent;
      }

      .status.error {
        display: block;
        background: var(--error-bg);
        color: var(--error-text);
        border-color: rgba(239, 68, 68, 0.35);
      }

      .status.success {
        display: block;
        background: var(--success-bg);
        color: var(--success-text);
        border-color: rgba(16, 185, 129, 0.35);
      }

      .status.info {
        display: block;
        background: var(--info-bg);
        color: var(--info-text);
        border-color: rgba(59, 130, 246, 0.35);
      }

      form {
        display: none;
      }
      form.active {
        display: block;
      }

      label {
        display: block;
        margin-bottom: 7px;
        margin-top: 12px;
        color: var(--text-secondary);
        font-size: 0.95rem;
        font-weight: 500;
      }

      input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 11px;
        padding: 12px;
        font-size: 1rem;
        background: rgba(15, 23, 42, 0.65);
        color: var(--text-primary);
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input::placeholder {
        color: var(--text-muted);
      }

      input:focus {
        border-color: rgba(99, 102, 241, 0.8);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.22);
      }

      .submit {
        width: 100%;
        margin-top: 18px;
        border: 0;
        border-radius: 11px;
        padding: 12px;
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        color: var(--text-primary);
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.16s ease, box-shadow 0.2s ease, filter 0.2s ease;
      }

      .submit:hover {
        filter: brightness(1.06);
        transform: translateY(-1px);
        box-shadow: 0 12px 30px rgba(99, 102, 241, 0.35);
      }

      .submit:active {
        transform: translateY(0);
      }

      /* ✅ Logged-in section (same theme) */
      #already-logged {
        display: none;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.55);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 16px;
        transition: opacity 220ms ease, transform 220ms ease;
      }

      #already-logged h2 {
        color: var(--text-primary);
        font-size: 1.05rem;
        margin-bottom: 8px;
      }

      #already-logged p {
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin-bottom: 12px;
        word-break: break-word;
      }

      .row-btns {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      /* ✅ Icon button for chat */
      .icon-btn {
        width: 46px;
        height: 46px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.65);
        color: var(--text-primary);
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: transform 160ms ease, border-color 200ms ease, box-shadow 200ms ease;
      }

      .icon-btn:hover {
        transform: translateY(-1px);
        border-color: rgba(99, 102, 241, 0.6);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
      }

      .icon-btn .material-icons {
        font-size: 22px;
      }

      .logout-wide {
        flex: 1;
        margin-top: 0;
      }

      @media (max-width: 480px) {
        body {
          padding: 14px;
        }
        .card {
          max-width: 100%;
          padding: 22px 16px;
          border-radius: 15px;
        }
        .title {
          font-size: 1.42rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="card fade-in" id="card">
      <button id="close-auth-btn" class="close-auth" type="button" aria-label="Back to chat">×</button>

      <h1 class="title">Genie</h1>

      <!-- ✅ Already logged in -->
      <div id="already-logged">
        <h2>✅ You are already logged in</h2>
        <p id="logged-email">Loading...</p>

        <div class="row-btns">
          <!-- ✅ ICON instead of button -->
          <button id="go-chat-btn" class="icon-btn" type="button" title="Go to Chat" aria-label="Go to Chat">
            <span class="material-icons">chat</span>
          </button>

          <button id="logout-btn" class="submit logout-wide" type="button">Logout</button>
        </div>
      </div>

      <div class="tabs" id="auth-tabs">
        <button class="tab active" id="tab-login" type="button">Login</button>
        <button class="tab" id="tab-signup" type="button">Sign Up</button>
      </div>

      <div id="status" class="status"></div>

      <form id="form-login" class="active" novalidate>
        <label for="login-username">Email</label>
        <input id="login-username" type="email" autocomplete="username" required />

        <label for="login-password">Password</label>
        <input id="login-password" type="password" autocomplete="current-password" required />

        <button class="submit" id="login-btn" type="submit">Login</button>
      </form>

      <form id="form-signup" novalidate>
        <label for="signup-username">Email</label>
        <input id="signup-username" type="email" autocomplete="username" required />

        <label for="signup-password">Password</label>
        <input id="signup-password" type="password" autocomplete="new-password" minlength="6" required />

        <label for="signup-confirm">Confirm Password</label>
        <input id="signup-confirm" type="password" autocomplete="new-password" minlength="6" required />

        <button class="submit" id="signup-btn" type="submit">Create Account</button>
      </form>
    </div>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        // ================= CONFIGURATION =================
        const SUPABASE_URL = "https://nikzyppkwedmzldghrgh.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pa3p5cHBrd2VkbXpsZGdocmdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0OTU1NzQsImV4cCI6MjA4NTA3MTU3NH0.ssb4-8V0wkkxyfDQSzfzgTrTbjxDu1OWyjogzJlupYM";

        if (!window.supabase) {
          alert("Supabase CDN failed to load. Check internet / script tag.");
          return;
        }

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { autoRefreshToken: true, persistSession: true, detectSessionInUrl: true },
        });

        // ================= UI ELEMENTS =================
        const card = document.getElementById("card");

        const tabLogin = document.getElementById("tab-login");
        const tabSignup = document.getElementById("tab-signup");
        const closeAuthBtn = document.getElementById("close-auth-btn");
        const loginForm = document.getElementById("form-login");
        const signupForm = document.getElementById("form-signup");
        const statusBox = document.getElementById("status");

        const loginBtn = document.getElementById("login-btn");
        const signupBtn = document.getElementById("signup-btn");

        const alreadyBox = document.getElementById("already-logged");
        const loggedEmail = document.getElementById("logged-email");
        const authTabs = document.getElementById("auth-tabs");
        const goChatBtn = document.getElementById("go-chat-btn");
        const logoutBtn = document.getElementById("logout-btn");

        // ================= HELPERS =================
        function showStatus(type, message) {
          statusBox.className = `status ${type}`;
          statusBox.textContent = message;
        }

        function clearStatus() {
          statusBox.className = "status";
          statusBox.textContent = "";
        }

        function setLoading(btn, isLoading, defaultText) {
          btn.disabled = isLoading;
          btn.textContent = isLoading ? "Please wait..." : defaultText;
        }

        function switchTab(mode) {
          clearStatus();
          const loginMode = mode === "login";
          tabLogin.classList.toggle("active", loginMode);
          tabSignup.classList.toggle("active", !loginMode);
          loginForm.classList.toggle("active", loginMode);
          signupForm.classList.toggle("active", !loginMode);
        }

        function showLoggedInUI(email) {
          alreadyBox.style.display = "block";
          authTabs.style.display = "none";
          loginForm.classList.remove("active");
          signupForm.classList.remove("active");
          loggedEmail.textContent = "Logged in as: " + (email || "");
          clearStatus();
        }

        function showAuthFormsUI() {
          alreadyBox.style.display = "none";
          authTabs.style.display = "flex";
          switchTab("login");
        }

        // ✅ Smooth animation when switching logged-in → login forms after logout
        function animateToLoginUI() {
          // fade out the card slightly
          card.classList.add("fade-out");

          setTimeout(() => {
            // show login UI
            showAuthFormsUI();

            // reset animation
            card.classList.remove("fade-out");
            // force reflow for clean transition
            void card.offsetWidth;
            card.classList.add("fade-in");
          }, 260);
        }

        // ================= EVENTS =================
        tabLogin.addEventListener("click", () => switchTab("login"));
        tabSignup.addEventListener("click", () => switchTab("signup"));

        closeAuthBtn.addEventListener("click", () => (window.location.href = "index.html"));
        goChatBtn.addEventListener("click", () => (window.location.href = "index.html"));

        logoutBtn.addEventListener("click", async () => {
          clearStatus();
          showStatus("info", "Logging out...");
          logoutBtn.disabled = true;

          const { error } = await supabaseClient.auth.signOut();
          logoutBtn.disabled = false;

          if (error) {
            showStatus("error", error.message);
            return;
          }

          showStatus("success", "Logged out successfully ✅");

          // ✅ after small delay, animate & show login page UI
          setTimeout(() => {
            clearStatus();
            animateToLoginUI();
          }, 450);
        });

        // ================= LOGIN =================
        loginForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          event.stopPropagation();
          clearStatus();

          const email = document.getElementById("login-username").value.trim();
          const password = document.getElementById("login-password").value;

          if (!email || !password) {
            showStatus("error", "Please enter email and password.");
            return;
          }

          showStatus("info", "Logging in...");
          setLoading(loginBtn, true, "Login");

          const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

          setLoading(loginBtn, false, "Login");

          if (error) {
            showStatus("error", error.message);
            return;
          }

          showStatus("success", "Login successful ✅");
          const sessionEmail = data?.user?.email || email;

          // optional: small animation to switch
          card.classList.add("fade-out");
          setTimeout(() => {
            card.classList.remove("fade-out");
            showLoggedInUI(sessionEmail);
          }, 220);
        });

        // ================= SIGNUP =================
        signupForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          event.stopPropagation();
          clearStatus();

          const email = document.getElementById("signup-username").value.trim();
          const password = document.getElementById("signup-password").value;
          const confirm = document.getElementById("signup-confirm").value;

          if (!email) {
            showStatus("error", "Email is required.");
            return;
          }
          if (password !== confirm) {
            showStatus("error", "Passwords do not match");
            return;
          }
          if (password.length < 6) {
            showStatus("error", "Password must be at least 6 characters");
            return;
          }

          showStatus("info", "Creating account...");
          setLoading(signupBtn, true, "Create Account");

          const { data, error } = await supabaseClient.auth.signUp({ email, password });

          setLoading(signupBtn, false, "Create Account");

          if (error) {
            showStatus("error", error.message);
            return;
          }

          if (data.user?.identities?.length === 0) {
            showStatus("error", "Email already registered. Try logging in.");
          } else {
            if (data.session) {
              showStatus("success", "Account created and logged in.");
              setTimeout(() => {
                showLoggedInUI(data.user?.email || email);
              }, 350);
            } else {
              showStatus("success", "Account created! Check your email for confirmation.");
              setTimeout(() => switchTab("login"), 1800);
            }
          }
        });

        // ================= CHECK SESSION (NO AUTO REDIRECT) =================
        (async function checkExistingSession() {
          const { data: { session }, error } = await supabaseClient.auth.getSession();

          if (error) {
            console.warn("Session check error:", error.message);
            showAuthFormsUI();
            return;
          }

          if (session) showLoggedInUI(session.user?.email || "");
          else showAuthFormsUI();
        })();
      });
    </script>
  </body>
</html>

